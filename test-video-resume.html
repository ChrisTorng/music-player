<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Resume Test - H.264 vs AV1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #4ec9b0;
            margin-bottom: 10px;
        }
        .info {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #4ec9b0;
        }
        .test-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .video-container {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
        }
        .video-container h2 {
            color: #dcdcaa;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .codec-info {
            color: #608b4e;
            font-size: 12px;
            margin-bottom: 10px;
        }
        video {
            width: 100%;
            background: #000;
            border-radius: 3px;
        }
        .controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
        }
        button:hover {
            background: #1177bb;
        }
        button:disabled {
            background: #3c3c3c;
            cursor: not-allowed;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            background: #1e1e1e;
            border-radius: 3px;
            font-size: 12px;
        }
        .status-line {
            padding: 2px 0;
        }
        .status-time {
            color: #4fc1ff;
        }
        .status-state {
            color: #ce9178;
        }
        .log-container {
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 5px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .log-container h3 {
            color: #4ec9b0;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #2d2d30;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-time {
            color: #858585;
        }
        .log-info {
            color: #4fc1ff;
        }
        .log-warn {
            color: #dcdcaa;
        }
        .log-error {
            color: #f48771;
        }
        .log-success {
            color: #4ec9b0;
        }
        .test-instructions {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #dcdcaa;
        }
        .test-instructions h3 {
            color: #dcdcaa;
            margin-bottom: 10px;
        }
        .test-instructions ol {
            margin-left: 20px;
        }
        .test-instructions li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ Video Resume Test: H.264 vs AV1</h1>

        <div class="info">
            <strong>æ¸¬è©¦ç›®çš„ï¼š</strong>å°æ¯” H.264 å’Œ AV1 ç·¨ç¢¼å½±ç‰‡åœ¨æš«åœå¾Œæ¢å¾©æ’­æ”¾æ™‚çš„è¡Œç‚ºå·®ç•°
        </div>

        <div class="test-instructions">
            <h3>ğŸ“‹ æ¸¬è©¦æ­¥é©Ÿ</h3>
            <ol>
                <li>é»æ“Šã€Œæ’­æ”¾æ‰€æœ‰å½±ç‰‡ã€æŒ‰éˆ•</li>
                <li>ç­‰å¾… 3-5 ç§’ï¼ˆè§€å¯Ÿæ™‚é–“æ›´æ–°ï¼‰</li>
                <li>é»æ“Šã€Œæš«åœæ‰€æœ‰å½±ç‰‡ã€æŒ‰éˆ•</li>
                <li>ç­‰å¾… 1 ç§’</li>
                <li>é»æ“Šã€Œæ¢å¾©æ’­æ”¾ã€æŒ‰éˆ•</li>
                <li><strong>è§€å¯Ÿæ—¥èªŒå’Œå½±ç‰‡æ™‚é–“</strong> - æ˜¯å¦å¾æš«åœä½ç½®ç¹¼çºŒï¼Ÿ</li>
            </ol>
        </div>

        <div class="test-section">
            <!-- H.264 Video (Working) -->
            <div class="video-container">
                <h2>âœ… H.264 å½±ç‰‡ï¼ˆæ¸¬è©¦ç”¨ï¼‰</h2>
                <div class="codec-info">ç·¨ç¢¼: H.264 | 640Ã—360 | 10ç§’</div>
                <video id="h264-video" preload="auto">
                    <source src="test/test/video/sync_test_video_fixed.mp4" type="video/mp4">
                </video>
                <div class="controls">
                    <button onclick="playVideo('h264')">æ’­æ”¾</button>
                    <button onclick="pauseVideo('h264')">æš«åœ</button>
                    <button onclick="resumeVideo('h264')">æ¢å¾©æ’­æ”¾</button>
                </div>
                <div class="status" id="h264-status">
                    <div class="status-line">ç‹€æ…‹: <span class="status-state" id="h264-state">æœªé–‹å§‹</span></div>
                    <div class="status-line">ç•¶å‰æ™‚é–“: <span class="status-time" id="h264-time">0.00</span>ç§’</div>
                    <div class="status-line">æš«åœæ™‚é–“: <span class="status-time" id="h264-paused-time">-</span>ç§’</div>
                    <div class="status-line">Seekable: <span id="h264-seekable">-</span></div>
                </div>
            </div>

            <!-- AV1 Video (Problem) -->
            <div class="video-container">
                <h2>âŒ AV1 å½±ç‰‡ï¼ˆLisztï¼‰</h2>
                <div class="codec-info">ç·¨ç¢¼: AV1 | 1920Ã—1080 | 287ç§’</div>
                <video id="av1-video" preload="auto">
                    <source src="Liszt-LiebestrÃ¤ume-No.3/home/video/home.mp4" type="video/mp4">
                </video>
                <div class="controls">
                    <button onclick="playVideo('av1')">æ’­æ”¾</button>
                    <button onclick="pauseVideo('av1')">æš«åœ</button>
                    <button onclick="resumeVideo('av1')">æ¢å¾©æ’­æ”¾</button>
                </div>
                <div class="status" id="av1-status">
                    <div class="status-line">ç‹€æ…‹: <span class="status-state" id="av1-state">æœªé–‹å§‹</span></div>
                    <div class="status-line">ç•¶å‰æ™‚é–“: <span class="status-time" id="av1-time">0.00</span>ç§’</div>
                    <div class="status-line">æš«åœæ™‚é–“: <span class="status-time" id="av1-paused-time">-</span>ç§’</div>
                    <div class="status-line">Seekable: <span id="av1-seekable">-</span></div>
                </div>
            </div>
        </div>

        <div class="controls" style="margin-bottom: 20px;">
            <button onclick="playAll()" style="background: #16825d;">â–¶ æ’­æ”¾æ‰€æœ‰å½±ç‰‡</button>
            <button onclick="pauseAll()" style="background: #a1260d;">â¸ æš«åœæ‰€æœ‰å½±ç‰‡</button>
            <button onclick="resumeAll()" style="background: #0e639c;">â© æ¢å¾©æ‰€æœ‰æ’­æ”¾</button>
            <button onclick="clearLog()" style="background: #3c3c3c;">ğŸ—‘ æ¸…é™¤æ—¥èªŒ</button>
        </div>

        <div class="log-container">
            <h3>ğŸ“Š è©³ç´°æ—¥èªŒ</h3>
            <div id="log"></div>
        </div>
    </div>

    <script>
        const videos = {
            h264: document.getElementById('h264-video'),
            av1: document.getElementById('av1-video')
        };

        const pausedTimes = {
            h264: null,
            av1: null
        };

        // Logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';

            const timestamp = new Date().toLocaleTimeString('en-US', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                fractionalSecondDigits: 3
            });

            entry.innerHTML = `<span class="log-time">[${timestamp}]</span> <span class="log-${type}">${message}</span>`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('æ—¥èªŒå·²æ¸…é™¤', 'info');
        }

        // Update status display
        function updateStatus(videoType) {
            const video = videos[videoType];
            document.getElementById(`${videoType}-time`).textContent = video.currentTime.toFixed(2);
            document.getElementById(`${videoType}-state`).textContent = video.paused ? 'æš«åœ' : 'æ’­æ”¾ä¸­';

            // Show seekable ranges
            const seekable = video.seekable;
            let ranges = [];
            for (let i = 0; i < seekable.length; i++) {
                ranges.push(`[${seekable.start(i).toFixed(2)}-${seekable.end(i).toFixed(2)}]`);
            }
            document.getElementById(`${videoType}-seekable`).textContent = ranges.length ? ranges.join(', ') : 'none';
        }

        // Set up event listeners
        Object.keys(videos).forEach(type => {
            const video = videos[type];

            video.addEventListener('loadedmetadata', () => {
                log(`[${type.toUpperCase()}] å½±ç‰‡å…ƒæ•¸æ“šå·²è¼‰å…¥ | duration=${video.duration.toFixed(2)}s`, 'info');
                updateStatus(type);
            });

            video.addEventListener('canplay', () => {
                log(`[${type.toUpperCase()}] å½±ç‰‡å¯ä»¥æ’­æ”¾ | readyState=${video.readyState}`, 'info');
            });

            video.addEventListener('play', () => {
                log(`[${type.toUpperCase()}] æ’­æ”¾äº‹ä»¶è§¸ç™¼ | currentTime=${video.currentTime.toFixed(2)}`, 'info');
                updateStatus(type);
            });

            video.addEventListener('pause', () => {
                log(`[${type.toUpperCase()}] æš«åœäº‹ä»¶è§¸ç™¼ | currentTime=${video.currentTime.toFixed(2)}`, 'info');
                updateStatus(type);
            });

            video.addEventListener('seeking', () => {
                log(`[${type.toUpperCase()}] Seeking åˆ° ${video.currentTime.toFixed(2)}`, 'warn');
            });

            video.addEventListener('seeked', () => {
                log(`[${type.toUpperCase()}] Seeked å®Œæˆæ–¼ ${video.currentTime.toFixed(2)}`, 'success');
                updateStatus(type);
            });

            video.addEventListener('timeupdate', () => {
                updateStatus(type);
            });

            video.addEventListener('error', (e) => {
                log(`[${type.toUpperCase()}] âŒ éŒ¯èª¤: ${video.error?.message || 'Unknown error'}`, 'error');
            });
        });

        // Control functions
        async function playVideo(type) {
            const video = videos[type];
            log(`[${type.toUpperCase()}] ğŸ¬ é–‹å§‹æ’­æ”¾...`, 'info');
            try {
                await video.play();
                log(`[${type.toUpperCase()}] âœ… æ’­æ”¾æˆåŠŸ`, 'success');
            } catch (error) {
                log(`[${type.toUpperCase()}] âŒ æ’­æ”¾å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function pauseVideo(type) {
            const video = videos[type];
            pausedTimes[type] = video.currentTime;
            document.getElementById(`${type}-paused-time`).textContent = pausedTimes[type].toFixed(2);
            log(`[${type.toUpperCase()}] â¸ æš«åœæ–¼ ${pausedTimes[type].toFixed(2)} ç§’`, 'warn');
            video.pause();
        }

        async function resumeVideo(type) {
            const video = videos[type];
            const targetTime = pausedTimes[type];

            log(`[${type.toUpperCase()}] ğŸ”„ æ¢å¾©æ’­æ”¾...`, 'info');
            log(`[${type.toUpperCase()}] ç›®æ¨™æ™‚é–“: ${targetTime?.toFixed(2) || 'N/A'}`, 'info');
            log(`[${type.toUpperCase()}] ç•¶å‰æ™‚é–“: ${video.currentTime.toFixed(2)}`, 'info');

            // Check seekable range before seek
            const seekable = video.seekable;
            let canSeek = false;
            for (let i = 0; i < seekable.length; i++) {
                if (targetTime >= seekable.start(i) && targetTime <= seekable.end(i)) {
                    canSeek = true;
                    break;
                }
            }

            const ranges = [];
            for (let i = 0; i < seekable.length; i++) {
                ranges.push(`[${seekable.start(i).toFixed(2)}-${seekable.end(i).toFixed(2)}]`);
            }
            log(`[${type.toUpperCase()}] Seekable ç¯„åœ: ${ranges.join(', ') || 'none'}`, 'info');
            log(`[${type.toUpperCase()}] å¯ä»¥ seek åˆ° ${targetTime.toFixed(2)}? ${canSeek ? 'æ˜¯' : 'å¦'}`, canSeek ? 'success' : 'warn');

            if (!canSeek && targetTime > 0) {
                log(`[${type.toUpperCase()}] âš ï¸ ç›®æ¨™æ™‚é–“ä¸åœ¨ seekable ç¯„åœå…§ï¼Œå˜—è©¦å…ˆæ’­æ”¾å† seek`, 'warn');
            }

            // Try to seek before play
            if (targetTime !== null && Math.abs(video.currentTime - targetTime) > 0.1) {
                log(`[${type.toUpperCase()}] ğŸ¯ Seek åˆ° ${targetTime.toFixed(2)} (æ’­æ”¾å‰)`, 'info');
                video.currentTime = targetTime;
                const actualTime = video.currentTime;
                log(`[${type.toUpperCase()}] Seek çµæœ: ${actualTime.toFixed(2)} (${actualTime === targetTime ? 'æˆåŠŸ' : 'å¤±æ•—'})`, actualTime === targetTime ? 'success' : 'error');
            }

            // Start playing
            try {
                await video.play();
                log(`[${type.toUpperCase()}] âœ… æ’­æ”¾å·²é–‹å§‹`, 'success');

                // If seek failed, try again after play starts
                if (targetTime !== null && Math.abs(video.currentTime - targetTime) > 0.1) {
                    log(`[${type.toUpperCase()}] ğŸ”„ æ’­æ”¾å¾Œç•¶å‰æ™‚é–“: ${video.currentTime.toFixed(2)}`, 'info');
                    log(`[${type.toUpperCase()}] ğŸ¯ æ’­æ”¾å¾Œé‡æ–° seek åˆ° ${targetTime.toFixed(2)}`, 'warn');

                    // Wait for buffering with retry
                    await seekWhenBuffered(type, targetTime);
                }
            } catch (error) {
                log(`[${type.toUpperCase()}] âŒ æ¢å¾©æ’­æ”¾å¤±æ•—: ${error.message}`, 'error');
            }
        }

        async function seekWhenBuffered(type, targetTime) {
            const video = videos[type];
            const maxAttempts = 30;

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                const seekable = video.seekable;
                let canSeek = false;

                for (let i = 0; i < seekable.length; i++) {
                    if (targetTime >= seekable.start(i) && targetTime <= seekable.end(i)) {
                        canSeek = true;
                        break;
                    }
                }

                if (canSeek) {
                    log(`[${type.toUpperCase()}] ğŸ¯ ç·©è¡å®Œæˆï¼Œå˜—è©¦ seek (ç¬¬ ${attempt} æ¬¡)`, 'info');
                    video.currentTime = targetTime;
                    const actualTime = video.currentTime;

                    if (Math.abs(actualTime - targetTime) < 0.1) {
                        log(`[${type.toUpperCase()}] âœ… Seek æˆåŠŸ: ${actualTime.toFixed(2)}`, 'success');
                        return;
                    } else if (Math.abs(actualTime - targetTime) < 1.0) {
                        log(`[${type.toUpperCase()}] âš ï¸ Seek éƒ¨åˆ†æˆåŠŸ: ${actualTime.toFixed(2)} (ç›®æ¨™: ${targetTime.toFixed(2)})`, 'warn');
                        return;
                    } else {
                        log(`[${type.toUpperCase()}] âŒ Seek å¤±æ•—: ${actualTime.toFixed(2)} != ${targetTime.toFixed(2)}`, 'error');
                    }
                } else {
                    const ranges = [];
                    for (let i = 0; i < seekable.length; i++) {
                        ranges.push(`[${seekable.start(i).toFixed(2)}-${seekable.end(i).toFixed(2)}]`);
                    }
                    if (attempt % 5 === 1 || attempt === maxAttempts) {
                        log(`[${type.toUpperCase()}] â³ ç­‰å¾…ç·©è¡... (ç¬¬ ${attempt} æ¬¡, seekable: ${ranges.join(', ') || 'none'})`, 'info');
                    }
                }

                await new Promise(resolve => setTimeout(resolve, 100));
            }

            log(`[${type.toUpperCase()}] âŒ ç·©è¡è¶…æ™‚ (${maxAttempts} æ¬¡å˜—è©¦)`, 'error');
        }

        // Batch controls
        async function playAll() {
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log('ğŸ¬ é–‹å§‹æ’­æ”¾æ‰€æœ‰å½±ç‰‡', 'info');
            await playVideo('h264');
            await playVideo('av1');
        }

        function pauseAll() {
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log('â¸ æš«åœæ‰€æœ‰å½±ç‰‡', 'warn');
            pauseVideo('h264');
            pauseVideo('av1');
        }

        async function resumeAll() {
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log('ğŸ”„ æ¢å¾©æ‰€æœ‰å½±ç‰‡æ’­æ”¾', 'info');
            await resumeVideo('h264');
            await resumeVideo('av1');
        }

        // Initialize
        log('âœ… æ¸¬è©¦é é¢å·²è¼‰å…¥', 'success');
        log('ğŸ“¹ H.264 å½±ç‰‡: test/test/video/sync_test_video_fixed.mp4', 'info');
        log('ğŸ“¹ AV1 å½±ç‰‡: Liszt-LiebestrÃ¤ume-No.3/home/video/home.mp4', 'info');
        log('è«‹æŒ‰ç…§ä¸Šæ–¹æ¸¬è©¦æ­¥é©Ÿæ“ä½œ', 'info');
    </script>
</body>
</html>
